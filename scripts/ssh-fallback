#!/usr/bin/env bash
set -euo pipefail

# 1) Destination + payload (host + remote command)
dest="$1"       # e.g. git@github.com
shift
cmd=( "$@" )    # e.g. git-receive-pack 'user/repo.git'

# 2) Find every non-.pub file in ~/.ssh named id_*
mapfile -t keys < <(
  find "$HOME/.ssh" -maxdepth 1 -type f \
    -name 'id_*' ! -name '*.pub' \
    -perm /u=r | sort
)

if (( ${#keys[@]} == 0 )); then
  echo "No SSH keys found in ~/.ssh" >&2
  exit 1
fi

# 3) Try each one quickly (no prompts, 5s timeout)
for key in "${keys[@]}"; do
  echo "Testing key: $(basename "$key")" >&2

  if ssh -i "$key" \
         -o IdentitiesOnly=yes \
         -o BatchMode=yes \
         -o ConnectTimeout=5 \
         "$dest" exit &>/dev/null; then
    # handshake ok â€“ now run the real push and hand off stdin/stdout
    exec ssh -i "$key" -o IdentitiesOnly=yes "$dest" "${cmd[@]}"
  fi
done

echo "No key could authenticate to $dest" >&2
exit 1

